(function(){var cacheDecisionPoint,cacheService,cacheUserVote,checkIfCurrentVersionOfApiServicePointIsInServicesCache,clearServiceCache,getPointsToVoteOn,initIfNewURL,initialize,messageMainView_noServiceMatch,popupOpen,popupParcel,reactor,refreshBadge,sendParcel,serviceMatchObj,servicesIndexAndServicesFullReady,servicesReady,tabUrl,updateBadgeText,updateMainViewData,updateService,updateServicesIndex,updatesCountTest,__indexOf=[].indexOf||function(item){for(var i=0,l=this.length;l>i;i++)if(i in this&&this[i]===item)return i;return-1};tabUrl="",serviceMatchObj={},updatesCountTest=0,popupOpen=!1,popupParcel={},sendParcel=function(parcel){var outPort;if(outPort=chrome.extension.connect({name:"fromBackgroundToPopup"}),null==parcel.msg||null==parcel.forUrl)return!1;switch(parcel.msg){case"popupParcel_ready":return refreshBadge(parcel.popupParcel),outPort.postMessage(parcel);case"noServiceMatch":return outPort.postMessage(parcel)}},updateMainViewData=function(pointsToVoteOn,nullOrCachedServices,servicesFull,serviceName,forUrl){var sendObj;return popupParcel={pointsToVoteOn:pointsToVoteOn,nullOrCachedServices:nullOrCachedServices,servicesFull:servicesFull,serviceName:serviceName},popupOpen?(sendObj={popupParcel:popupParcel,forUrl:forUrl,msg:"popupParcel_ready"},sendParcel(sendObj)):refreshBadge(popupParcel)},messageMainView_noServiceMatch=function(forUrl){var sendObj;return sendObj={forUrl:forUrl,msg:"noServiceMatch"},sendParcel(sendObj)},cacheService=function(servicesCache,servicesFull,serviceName,currentTime,callback){return null==servicesCache[serviceName]?(servicesCache[serviceName]={},servicesCache[serviceName].canonicalTimestamp=currentTime,servicesCache[serviceName].canonical={},null!=servicesFull[serviceName].service.links&&(servicesCache[serviceName].canonical.links=servicesFull[serviceName].service.links),null!=servicesFull[serviceName].service.twitter&&(servicesCache[serviceName].canonical.twitter=servicesFull[serviceName].service.twitter),servicesCache[serviceName].decisionPoints={},servicesCache[serviceName].sharedTotalResults=[]):currentTime-servicesCache[serviceName].canonicalTimestamp<864e5&&(servicesCache[serviceName].canonicalTimestamp=currentTime,servicesCache[serviceName].canonical={},null!=servicesFull[serviceName].service.links&&(servicesCache[serviceName].canonical.links=servicesFull[serviceName].service.links),null!=servicesFull[serviceName].service.twitter&&(servicesCache[serviceName].canonical.twitter=servicesFull[serviceName].service.twitter)),chrome.storage.local.set({servicesCache:servicesCache},function(){return callback(servicesCache)})},cacheDecisionPoint=function(servicesCache,servicesFull,serviceName,userAgreedBool,pointId,currentTime,callback){var canonical,rawPointData,setObj;return null!=servicesCache[serviceName]&&null!=servicesFull[serviceName]&&null!=servicesFull[serviceName].service.pointsData[pointId]?(null==servicesCache[serviceName].decisionPoints[pointId]&&(servicesCache[serviceName].decisionPoints[pointId]=[]),rawPointData=servicesFull[serviceName].service.pointsData[pointId],canonical={id:pointId,title:rawPointData.title},null!=rawPointData.tosdr&&null!=rawPointData.tosdr.tldr&&(canonical.tldr=rawPointData.tosdr.tldr),null!=rawPointData.meta&&(canonical.meta=rawPointData.meta),null!=rawPointData.source&&(canonical.source=rawPointData.source),null!=rawPointData.discussion&&(canonical.discussion=rawPointData.discussion),setObj={canonical:canonical,timestamp:currentTime,voteAgree:userAgreedBool,deleted:!1,shared:[]},servicesCache[serviceName].decisionPoints[pointId].push(setObj),chrome.storage.local.set({servicesCache:servicesCache},function(){return callback(servicesCache,serviceName,pointId)})):void 0},cacheUserVote=function(userAgreedBool,serviceName,pointId){var currentTime;return currentTime=Date.now(),chrome.storage.local.get("servicesFull",function(response){var servicesFull;return null==response.servicesFull||0===Object.keys(response.servicesFull).length?!1:(servicesFull=response.servicesFull,null!=servicesFull[serviceName]&&null!=servicesFull[serviceName].service.pointsData[pointId]?chrome.storage.local.get("servicesCache",function(_r){var servicesCache;return null==_r.servicesCache||0===Object.keys(_r.servicesCache).length||null==_r.servicesCache[serviceName]||currentTime-_r.servicesCache[serviceName].canonicalTimestamp<864e5?(servicesCache=null==_r.servicesCache?{}:_r.servicesCache,cacheService(servicesCache,servicesFull,serviceName,currentTime,function(_servicesCache){return cacheDecisionPoint(_servicesCache,servicesFull,serviceName,userAgreedBool,pointId,currentTime,function(__servicesCache,_serviceName,_pointId){return getPointsToVoteOn(servicesFull,serviceName,function(pointsToVoteOn,nullOrCachedServices){var setObj;return setObj={},setObj.msg="popupParcel_ready",setObj.forUrl=tabUrl,setObj.popupParcel={serviceName:_serviceName,pointId:_pointId,forUrl:tabUrl,servicesFull:servicesFull,pointsToVoteOn:pointsToVoteOn,nullOrCachedServices:nullOrCachedServices},popupParcel=setObj.popupParcel,sendParcel(setObj)})})})):cacheDecisionPoint(_r.servicesCache,servicesFull,serviceName,userAgreedBool,pointId,currentTime,function(__servicesCache,_serviceName,_pointId){return getPointsToVoteOn(servicesFull,serviceName,function(pointsToVoteOn,nullOrCachedServices){var setObj;return setObj={},setObj.msg="popupParcel_ready",setObj.forUrl=tabUrl,setObj.popupParcel={serviceName:_serviceName,pointId:_pointId,forUrl:tabUrl,servicesFull:servicesFull,pointsToVoteOn:pointsToVoteOn,nullOrCachedServices:nullOrCachedServices},popupParcel=setObj.popupParcel,sendParcel(setObj)})})}):void 0)})},clearServiceCache=function(serviceName){return chrome.storage.local.get("servicesCache",function(_r){return null==_r.servicesCache||0===Object.keys(_r.servicesCache).length||null==_r.servicesCache[serviceName]?!1:(delete _r.servicesCache[serviceName],chrome.storage.local.set({servicesCache:_r.servicesCache},function(){return chrome.tabs.getSelected(null,function(tab){var setObj;return setObj={},setObj.msg="popupParcel_ready",setObj.forUrl=tabUrl,null!=popupParcel?(setObj.popupParcel=popupParcel,setObj.popupParcel.pointsToVoteOn=popupParcel.servicesFull[serviceName].service.pointsData,setObj.popupParcel.nullOrCachedServices=_r.servicesCache,popupParcel=setObj.popupParcel,sendParcel(setObj)):void 0})}))})},chrome.extension.onConnect.addListener(function(port){return"fromPopupToBackground"===port.name?port.onMessage.addListener(function(dataFromPopup){var sendObj;if(null==dataFromPopup.msg)return!1;switch(dataFromPopup.msg){case"post_clearService":return clearServiceCache(dataFromPopup.serviceName);case"post_userVote":if(dataFromPopup.forUrl===tabUrl)return cacheUserVote(dataFromPopup.userAgreedBool,dataFromPopup.serviceName,dataFromPopup.pointId);break;case"request_popupParcel":return popupOpen=!0,tabUrl===serviceMatchObj.forUrl&&serviceMatchObj.serviceMatch===!1?messageMainView_noServiceMatch(tabUrl):Object.keys(popupParcel).length>0&&tabUrl===dataFromPopup.forUrl?(sendObj={popupParcel:popupParcel,forUrl:tabUrl,msg:"popupParcel_ready"},sendParcel(sendObj)):tabUrl===dataFromPopup.forUrl?(sendObj={msg:"popupParcel_pending",forUrl:tabUrl},sendParcel(sendObj)):messageMainView_noServiceMatch(tabUrl)}}):void 0}),reactor=new bReactor,reactor.registerEvent("deliverServices"),reactor.addEventListener("deliverServices",function(ingredientObj){return null!=ingredientObj.forUrl&&ingredientObj.forUrl===tabUrl?servicesReady(ingredientObj.services,ingredientObj.forUrl):void 0}),checkIfCurrentVersionOfApiServicePointIsInServicesCache=function(serviceApiPointsObject,cachedPoints,pointId){var _i;if(_i=cachedPoints[pointId].length-1,null!=serviceApiPointsObject[pointId].meta||null!=cachedPoints[pointId][_i].canonical.meta){if(null==serviceApiPointsObject[pointId].meta||null==cachedPoints[pointId][_i].canonical.meta)return!1;if(!_.isEqual(serviceApiPointsObject[pointId].meta,cachedPoints[pointId][_i].canonical.meta))return!1}if(null!=serviceApiPointsObject[pointId].source||null!=cachedPoints[pointId][_i].canonical.source){if(null==serviceApiPointsObject[pointId].source||null==cachedPoints[pointId][_i].canonical.source)return!1;if(!_.isEqual(serviceApiPointsObject[pointId].source,cachedPoints[pointId][_i].canonical.source))return!1}if(null!=serviceApiPointsObject[pointId].title||null!=cachedPoints[pointId][_i].canonical.title){if(null==serviceApiPointsObject[pointId].title||null==cachedPoints[pointId][_i].canonical.title)return!1;if(!_.isEqual(serviceApiPointsObject[pointId].title,cachedPoints[pointId][_i].canonical.title))return!1}else if(null==cachedPoints[pointId][_i].canonical.title)return!1;if(null!=serviceApiPointsObject[pointId].tosdr.tldr||null!=cachedPoints[pointId][_i].canonical.tldr){if(null==serviceApiPointsObject[pointId].tosdr.tldr||null==cachedPoints[pointId][_i].canonical.tldr)return!1;if(!_.isEqual(serviceApiPointsObject[pointId].tosdr.tldr,cachedPoints[pointId][_i].canonical.tldr))return!1}else if(null==cachedPoints[pointId][_i].canonical.tldr)return!1;return!0},getPointsToVoteOn=function(servicesFull,serviceName,callback){var service,serviceApiPointsObject;return service=servicesFull[serviceName].service,serviceApiPointsObject=_.extend({},service.pointsData),chrome.storage.local.get("servicesCache",function(response){var apiPointIds,decisionPoint,pointId,_ref;if(apiPointIds=Object.keys(servicesFull[serviceName].service.pointsData),null!=response.servicesCache){if(null!=response.servicesCache[serviceName]){_ref=response.servicesCache[serviceName].decisionPoints;for(pointId in _ref)decisionPoint=_ref[pointId],__indexOf.call(apiPointIds,pointId)>=0&&checkIfCurrentVersionOfApiServicePointIsInServicesCache(serviceApiPointsObject,response.servicesCache[serviceName].decisionPoints,pointId)&&delete serviceApiPointsObject[pointId];return callback(serviceApiPointsObject,response.servicesCache)}return callback(serviceApiPointsObject,response.servicesCache)}return callback(serviceApiPointsObject,null)})},updateBadgeText=function(text){return chrome.browserAction.setBadgeText({text:text.toString()})},servicesIndexAndServicesFullReady=function(servicesIndex,servicesFull,serviceName,forUrl){return null!=servicesFull[serviceName]?(serviceMatchObj={forUrl:forUrl,serviceMatch:!0},getPointsToVoteOn(servicesFull,serviceName,function(pointsToVoteOn,nullOrCachedServices){return forUrl===tabUrl?updateMainViewData(pointsToVoteOn,nullOrCachedServices,servicesFull,serviceName,forUrl):void 0})):serviceMatchObj={forUrl:forUrl,serviceMatch:!1}},updateServicesIndex=function(currentUrl){var timestamp;return timestamp=Date.now(),$.ajax("https://tosdr.org/index/services.json",{success:function(servicesIndex){var getVanity,name,serviceNamesArray,setObj,vanityHash,_j,_len;for(null!=servicesIndex["world-of-warcraft"]&&delete servicesIndex["world-of-warcraft"],null!=servicesIndex["microsoft-store"]&&(servicesIndex.microsoftstore=servicesIndex["microsoft-store"],delete servicesIndex["microsoft-store"]),null!=servicesIndex["apple-icloud"]&&(servicesIndex.icloud=servicesIndex["apple-icloud"],delete servicesIndex["apple-icloud"]),null!=servicesIndex["mint.com"]&&(servicesIndex.mint=servicesIndex["mint.com"],delete servicesIndex["mint.com"]),serviceNamesArray=Object.keys(servicesIndex),getVanity=function(name){var fragments;return fragments=name.split("-"),1===fragments.length?fragments[0]:fragments[fragments.length-2]},vanityHash={},_j=0,_len=serviceNamesArray.length;_len>_j;_j++)name=serviceNamesArray[_j],vanityHash[getVanity(name)]=name;return setObj={vanityHash:vanityHash,timestamp:timestamp},chrome.storage.local.set({services:setObj},function(services){return reactor.dispatchEvent("deliverServices",{services:setObj,forUrl:currentUrl})})}})},updateService=function(servicesFullObject,serviceName,currentUrl,callback,servicesIndex){var timestamp;return null==servicesFullObject&&(servicesFullObject={}),null==servicesIndex&&(servicesIndex=null),timestamp=Date.now(),$.getJSON("https://tosdr.org/api/1/service/"+serviceName+".json").done(function(serviceFull){var setObj;return setObj={service:serviceFull,timestamp:timestamp},servicesFullObject[serviceName]=setObj,chrome.storage.local.set({servicesFull:servicesFullObject},function(){return null!=servicesIndex?callback(servicesIndex,servicesFullObject,serviceName,currentUrl):callback(servicesFullObject,serviceName,currentUrl)})})},refreshBadge=function(popupParcel){var decisionPointsArray,pointName,totalCount,voteYesCount,_ref;if(Object.keys(popupParcel.pointsToVoteOn).length>0)return updateBadgeText(Object.keys(popupParcel.pointsToVoteOn).length);if(null!=popupParcel.nullOrCachedServices[popupParcel.serviceName]&&null!=popupParcel.nullOrCachedServices[popupParcel.serviceName].decisionPoints&&Object.keys(popupParcel.nullOrCachedServices[popupParcel.serviceName].decisionPoints).length>0){voteYesCount=0,totalCount=0,_ref=popupParcel.nullOrCachedServices[popupParcel.serviceName].decisionPoints;for(pointName in _ref)decisionPointsArray=_ref[pointName],decisionPointsArray[decisionPointsArray.length-1].voteAgree&&voteYesCount++,totalCount++;return updateBadgeText(voteYesCount+"/"+totalCount)}},servicesReady=function(servicesIndex,forUrl){var COMfrags,DOTfrags,currentTime,domainName,domainPreTLD,protocolFRAGS;if(currentTime=Date.now(),COMfrags=forUrl.split(".com"),-1!==forUrl.indexOf("wikipedia.org")&&(COMfrags=forUrl.split(".org")),COMfrags.length>1){if(DOTfrags=COMfrags[COMfrags.length-2].split("."),domainPreTLD=DOTfrags[DOTfrags.length-1],protocolFRAGS=domainPreTLD.split("//"),domainName=protocolFRAGS[protocolFRAGS.length-1],null!=servicesIndex.vanityHash[domainName])return serviceMatchObj={forUrl:forUrl,serviceMatch:!0},chrome.storage.local.get(null,function(allItems){var servicesFullObj;return null!=allItems.servicesFull?null!=allItems.servicesFull[servicesIndex.vanityHash[domainName]]&&currentTime-allItems.servicesFull[servicesIndex.vanityHash[domainName]].timestamp<221e5?(serviceMatchObj={forUrl:forUrl,serviceMatch:!0},servicesIndexAndServicesFullReady(servicesIndex,allItems.servicesFull,servicesIndex.vanityHash[domainName],forUrl)):updateService(allItems.servicesFull,servicesIndex.vanityHash[domainName],forUrl,servicesIndexAndServicesFullReady,servicesIndex):(servicesFullObj={},updateService(servicesFullObj,servicesIndex.vanityHash[domainName],forUrl,servicesIndexAndServicesFullReady,servicesIndex))});if(serviceMatchObj={forUrl:forUrl,serviceMatch:!1},popupOpen)return messageMainView_noServiceMatch(tabUrl)}else if(serviceMatchObj={forUrl:forUrl,serviceMatch:!1},popupOpen)return messageMainView_noServiceMatch(tabUrl)},initialize=function(currentUrl){var currentTime;return updatesCountTest++,currentTime=Date.now(),chrome.storage.local.get(null,function(allItemsInLocalStorage){return null!=allItemsInLocalStorage.services?currentTime-allItemsInLocalStorage.services.timestamp<864e5?updateServicesIndex(currentUrl):reactor.dispatchEvent("deliverServices",{services:allItemsInLocalStorage.services,forUrl:currentUrl}):updateServicesIndex(currentUrl)})},initIfNewURL=function(){return popupOpen=!1,chrome.tabs.getSelected(null,function(tab){return chrome.storage.local.get("persistentUrl",function(data){var currentUrl;return data.persistentUrl!==tab.url&&(updateBadgeText(""),chrome.storage.local.set({persistentUrl:tab.url},function(){})),currentUrl=tab.url,"complete"!==document.readyState&&currentUrl!==tabUrl?(tabUrl=currentUrl,$(document).ready(function(){return initialize(currentUrl)})):currentUrl!==tabUrl?(tabUrl=currentUrl,initialize(currentUrl)):void 0})})},chrome.tabs.onActivated.addListener(initIfNewURL),chrome.tabs.onUpdated.addListener(initIfNewURL),chrome.windows.onFocusChanged.addListener(initIfNewURL)}).call(this);